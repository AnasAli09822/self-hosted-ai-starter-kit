# نظام الذكاء الاصطناعي ثنائي المسار للمحادثات التجارية

## نظرة عامة على النظام

يوفر هذا النظام حلاً متكاملاً لإدارة المحادثات التجارية باستخدام الذكاء الاصطناعي، مع تقسيم العمل إلى مسارين منفصلين لضمان الأمان والكفاءة القصوى.

### الهندسة المعمارية

#### 1. مسار العمل الإداري (Admin Workflow)
- **الهدف**: إدارة قاعدة المعرفة وشخصية البوت
- **المستخدمون**: المالك/المدير فقط
- **الوظائف**:
  - إضافة منتجات جديدة مع الصور والأوصاف
  - تحديث شخصية البوت
  - فهرسة المحتوى باستخدام التضمين المتجه (Vector Embeddings)

#### 2. مسار العمل للمستخدمين (User Workflow)  
- **الهدف**: خدمة العملاء 24/7
- **المستخدمون**: العملاء والزوار
- **الوظائف**:
  - استقبال الأسئلة النصية والصوتية
  - البحث الذكي في قاعدة المعرفة
  - الرد بمعلومات المنتجات والصور
  - تسجيل المحادثات

### استراتيجية البيانات الهجينة

#### MongoDB Atlas
- **الاستخدام**: البحث المتجه الذكي
- **البيانات المخزنة**:
  - قاعدة معرفة المنتجات (`knowledge_base`)
  - إعدادات شخصية البوت (`bot_settings`)

#### Google Sheets
- **الاستخدام**: تسجيل ومراقبة المحادثات
- **البيانات المخزنة**:
  - التوقيت
  - معرف المستخدم واسمه
  - الاستفسار والرد

## متطلبات التثبيت

### 1. الخدمات الخارجية

#### MongoDB Atlas
1. أنشئ حساب على [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. أنشئ cluster جديد (يمكن استخدام الطبقة المجانية)
3. احصل على connection string
4. فعّل Vector Search للمجموعات

#### OpenAI API
1. أنشئ حساب على [OpenAI](https://platform.openai.com/)
2. احصل على API key
3. تأكد من وجود رصيد في الحساب

#### Telegram Bots
1. تحدث مع [@BotFather](https://t.me/botfather) على تليجرام
2. أنشئ بوتين منفصلين:
   - بوت إداري للمدير
   - بوت عام للعملاء
3. احصل على Bot Tokens لكل منهما
4. احصل على Chat ID للمدير (يمكن الحصول عليه من [@userinfobot](https://t.me/userinfobot))

#### Google Sheets API
1. انتقل إلى [Google Cloud Console](https://console.cloud.google.com/)
2. أنشئ مشروع جديد أو استخدم موجود
3. فعّل Google Sheets API
4. أنشئ Service Account
5. نزل ملف JSON للمفاتيح
6. أنشئ ملف Google Sheets جديد
7. شارك الملف مع عنوان البريد الإلكتروني للـ Service Account
8. أنشئ ورقة عمل باسم "المحادثات" مع العناوين التالية:
   - التوقيت
   - معرف المستخدم  
   - اسم المستخدم
   - استفسار المستخدم
   - رد البوت

### 2. تكوين متغيرات البيئة

قم بتحديث ملف `.env` بالقيم التالية:

```env
# OpenAI Configuration
OPENAI_API_KEY=your_actual_openai_api_key

# MongoDB Atlas Configuration  
MONGODB_CONNECTION_STRING=mongodb+srv://username:password@cluster.mongodb.net/database_name

# Telegram Bot Configuration
TELEGRAM_ADMIN_BOT_TOKEN=your_admin_bot_token
TELEGRAM_USER_BOT_TOKEN=your_user_bot_token
TELEGRAM_ADMIN_CHAT_ID=your_admin_chat_id

# Google Sheets Configuration
GOOGLE_SHEETS_SERVICE_ACCOUNT_EMAIL=your_service_account_email
GOOGLE_SHEETS_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nyour_private_key\n-----END PRIVATE KEY-----"
GOOGLE_SHEETS_SPREADSHEET_ID=your_spreadsheet_id
```

### 3. تشغيل النظام

```bash
# تشغيل النظام بدون GPU
docker compose --profile cpu up

# أو للأنظمة مع Nvidia GPU
docker compose --profile gpu-nvidia up

# أو للأنظمة مع AMD GPU على Linux
docker compose --profile gpu-amd up
```

### 4. التكوين الأولي في n8n

1. افتح متصفح واذهب إلى <http://localhost:5678>
2. أنشئ حساب إداري جديد
3. انتقل إلى إعدادات الاعتماد (Credentials)
4. قم بإعداد كل اعتماد بالقيم الصحيحة:
   - MongoDB Atlas Connection
   - OpenAI API
   - Telegram Admin Bot
   - Telegram User Bot  
   - Google Sheets API
5. فعّل كلا المسارين (Admin و User Workflows)

## استخدام النظام

### للمدير (مسار العمل الإداري)

#### إضافة منتج جديد
1. أرسل صورة للمنتج إلى البوت الإداري
2. أضف تعليق منظم بالشكل التالي:
```
الاسم: آيفون 15 برو ماكس
الوصف: هاتف ذكي متطور بشاشة 6.7 بوصة ومعالج A17 Pro
معلومات: متوفر بألوان متعددة، ذاكرة 256GB، كاميرا 48MP
```

#### تحديث شخصية البوت
أرسل رسالة تبدأ بـ `/set_persona` متبوعة بالشخصية الجديدة:
```
/set_persona أنت مساعد خبير في الإلكترونيات، ودود وتستخدم الرموز التعبيرية. تقدم معلومات دقيقة ومفيدة للعملاء.
```

### للعملاء (مسار العمل للمستخدمين)

#### الاستفسار النصي
أرسل أي سؤال متعلق بالمنتجات:
```
"أريد هاتف آيفون جديد"
"ما هي المنتجات المتوفرة؟"
"أحتاج إلى معلومات عن اللابتوب"
```

#### الاستفسار الصوتي
أرسل رسالة صوتية وسيتم تحويلها إلى نص تلقائياً ومعالجتها.

## المراقبة والصيانة

### مراقبة الأداء
- تابع سجلات Docker: `docker compose logs -f`
- راقب استهلاك الـ API في OpenAI Dashboard
- تابع استخدام MongoDB Atlas في لوحة التحكم

### النسخ الاحتياطي
- قم بنسخ قاعدة بيانات MongoDB بشكل دوري
- احتفظ بنسخة من ملف Google Sheets
- قم بحفظ إعدادات n8n بانتظام

### الاستكشاف والإصلاح

#### مشاكل شائعة:

1. **عدم تلقي الرسائل**
   - تأكد من صحة Bot Tokens
   - تحقق من تفعيل الـ Webhooks

2. **مشاكل البحث في المنتجات**
   - تأكد من صحة MongoDB connection string
   - تحقق من فهرسة المنتجات بشكل صحيح

3. **مشاكل Google Sheets**
   - تأكد من مشاركة الملف مع Service Account
   - تحقق من صحة اسم ورقة العمل

## الأمان

### أفضل الممارسات:
- لا تشارك Bot Tokens مع أي شخص
- استخدم HTTPS في الإنتاج
- قم بتحديث كلمات المرور بانتظام
- راقب السجلات للأنشطة المشبوهة
- احتفظ بنسخ احتياطية منتظمة

### الامتثال:
- يتوافق النظام مع سياسات n8n للاستخدام
- يحترم حدود استخدام API للخدمات المستخدمة
- يضمن حماية بيانات المستخدمين وفقاً لأفضل الممارسات

## الدعم والتطوير

### التحديثات المستقبلية:
- إضافة دعم للمزيد من اللغات
- تحسين دقة البحث المتجه
- إضافة تحليلات متقدمة للمحادثات
- دعم المزيد من تنسيقات الملفات

### المساهمة في التطوير:
- تقديم اقتراحات التحسين
- الإبلاغ عن الأخطاء
- مشاركة حالات الاستخدام الجديدة

هذا النظام يوفر حلاً شاملاً ومتقدماً لإدارة المحادثات التجارية باستخدام أحدث تقنيات الذكاء الاصطناعي، مع ضمان الأمان والكفاءة في الأداء.